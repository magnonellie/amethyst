---
platform: linux

params:
  MDBOOK_RELEASE: 0.2.1

image_resource:
  type: docker-image
  source:
    repository: rustdocker/rust
    tag: stable

inputs:
- name: amethyst
- name: target

run:
  path: sh
  dir: amethyst
  args:
  - -exc
  - |
    echo "Fetching dependencies..."
    apt-get update > /dev/null
    apt-get install -y \
      libasound2-dev libx11-xcb-dev libssl-dev cmake libfreetype6-dev libexpat1-dev libxcb1-dev python3 \
      build-essential libsdl2-dev > /dev/null
    echo "Testing the book..."
    curl -L -o mdbook.tar.gz https://github.com/rust-lang-nursery/mdBook/releases/download/v${MDBOOK_RELEASE}/mdbook-v${MDBOOK_RELEASE}-x86_64-unknown-linux-gnu.tar.gz
    tar -xvf mdbook.tar.gz -C ./
    rm mdbook.tar.gz
    ./mdbook test book -L ../target/debug/deps
